[![codecov](https://codecov.io/gh/tamzidkarim/nodejs-microservices/branch/main/graph/badge.svg?token=71CWKVZH1R)](https://codecov.io/gh/tamzidkarim/nodejs-microservices)

<img src="https://img.shields.io/badge/Nginx-009639?style=for-the-badge&logo=nginx&logoColor=white" />
<img src="https://img.shields.io/badge/Node.js-339933?style=for-the-badge&logo=nodedotjs&logoColor=white" />
<img src="https://img.shields.io/badge/TypeScript-007ACC?style=for-the-badge&logo=typescript&logoColor=white" />
<img src="https://img.shields.io/badge/MongoDB-4EA94B?style=for-the-badge&logo=mongodb&logoColor=white" />
<img src="https://img.shields.io/badge/eslint-3A33D1?style=for-the-badge&logo=eslint&logoColor=white" />
<img src="https://img.shields.io/badge/prettier-1A2C34?style=for-the-badge&logo=prettier&logoColor=F7BA3E" />
<img src="https://img.shields.io/badge/Docker-2CA5E0?style=for-the-badge&logo=docker&logoColor=white" />
<img src="https://img.shields.io/badge/Jest-C21325?style=for-the-badge&logo=jest&logoColor=white" />
<img src="https://img.shields.io/badge/Swagger-85EA2D?style=for-the-badge&logo=Swagger&logoColor=white" />

# Node.js recruitment task

## Description

The task is to create a movie microservice incorporating with the already developed auth service. A description of the original assignment is here: [Recruitment-Task].

## Technology stack

- TypeScript
- Node.js
- Express
- MongoDB
- Mongoose
- Nginx
- Docker
- Axios
- Jest
- Swagger

**Overview of the Project**

1. There are two small Node based microservices: Movies and Auth Services.

- `Authorization Service` - authenticates a user by providing a JWT token
- `Movies Service` - user can add movies and fetch them

2. Creating and fetching movies data is protected and Authorization token is required. The token should be passed in request's Authorization header to be authorized.
3. The `Movies Service` is dockerized in movie-service, and the `Auth Service` is dockerized in auth-service. You can run them separately. Also The Movies and Auth services are dockerized together (if you want to run services together). Make sure to have docker and docker-compose installed.
4. By default `Movies Service` starts on port 3000 and `Auth Service` starts on port 8888.
5. Having Nginx running as a proxy, we can access both of the services just by hitting `localhost`. Nginx is working a api-gateway and proxy-passing the requests to their intended servers. So that we don't have to deal with different servers. We just need to know the url of api-gateway and it will intelligently forward the requests to the expected servers.

**Top Level Project Structure**

`root` - root directory contains nginx config, makefile and docker-compose file to run the whole project.

`auth-service` - it contains the codes for `Authorization Service`

`movie-service` - it contains the codes for `Movies Service`

Documentation about the API is autogenerated with Swagger and it is available under the `http://localhost:3000/api-docs`

## Prerequisites

You need to have `docker` and `docker-compose` installed on your computer to run the service

### Run locally

- Clone this repository and then cd into `nodejs-microservices`:

```
git clone https://github.com/tamzidkarim/nodejs-microservices.git
```

- If you can run `make` commands in your machine, then you need to use one command to run the project

```
make all OMDB_API_KEY=<YOUR_OMDB_API_KEY>
```

- Or else you can run containers from root dir using docker-compose (first time it will build images automatically):

```
OMDB_API_KEY=<YOUR_OMDB_API_KEY> docker-compose up -d
```

(optional) you can also specify custom ports for movies and auth services:

```
MOVIE_SVC_PORT=<MOVIE_SVC_PORT> AUTH_SVC_PORT=<AUTH_SVC_PORT> OMDB_API_KEY=<YOUR_OMDB_API_KEY> docker-compose up -d
```

`OMDB_API_KEY` are mandatory. Without `OMDB_API_KEY` user wont be able to add movies.

- To stop the services run: `docker-compose down` or `make down`

## Movies service

The `Movies Service` contains an express server and a mongodb database.

There are several important points:

1. To add or fetch movies users need to be authorized.
2. `Basic` users can add five movies per calendar month and fetch movie list unlimited times.
3. `Premium` users have no limits: can add unlimited number of movies per month and fetch movie list unlimited times.

**You can start Movies Service separately** under movies-service folder (specify the same `JWT_SECRET` variable value as the one you used to run the `Auth Service`):

```

make start OMDB_API_KEY=<YOUR_OMDB_API_KEY>

```

```

OMDB_API_KEY=<OMDB_API_KEY> docker-compose up -d

```

**Example POST**
Request:

```

curl --location --request POST 'http://localhost/movies' \
--header 'Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOjEyMywibmFtZSI6IkJhc2ljIFRob21hcyIsInJvbGUiOiJiYXNpYyIsImlhdCI6MTYyNTQ5MTI4MywiZXhwIjoxNjI1NDkzMDgzLCJpc3MiOiJodHRwczovL3d3dy5uZXRndXJ1LmNvbS8iLCJzdWIiOiIxMjMifQ.jmZgZAadfcpo82dsfxn7TvKBhw5uN9nq34WgKGgOcus' \
--header 'Content-Type: application/json' \
--data-raw '{
"title": "iron man 3"
}'

```

OR, if you want to access the server directly using port address,

```

curl --location --request POST 'http://localhost:3000/movies' \
--header 'Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOjEyMywibmFtZSI6IkJhc2ljIFRob21hcyIsInJvbGUiOiJiYXNpYyIsImlhdCI6MTYyNTQ5MTI4MywiZXhwIjoxNjI1NDkzMDgzLCJpc3MiOiJodHRwczovL3d3dy5uZXRndXJ1LmNvbS8iLCJzdWIiOiIxMjMifQ.jmZgZAadfcpo82dsfxn7TvKBhw5uN9nq34WgKGgOcus' \
--header 'Content-Type: application/json' \
--data-raw '{
"title": "iron man 3"
}'

```

Response:

```

{
    "data": {
        "_id": "624b8852ea1e5b0040a43db6",
        "title": "Iron Man 3",
        "release": "Fri May 03 2013 00:00:00 GMT+0000 (Coordinated Universal Time)",
        "genre": "Action, Adventure, Sci-Fi",
        "director": "Shane Black",
        "userId": 123,
        "createdAt": "2022-04-05T00:07:46.215Z",
        "updatedAt": "2022-04-05T00:07:46.215Z",
        "__v": 0
    },
    "message": "Movie 'iron man 3' has been successfully added"
}

```

**Example GET**
Request:

```

curl --location --request GET 'http://localhost:3000/movies' \
--header 'Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOjEyMywibmFtZSI6IkJhc2ljIFRob21hcyIsInJvbGUiOiJiYXNpYyIsImlhdCI6MTY0OTExNzEyOSwiZXhwIjoxNjQ5MTE4OTI5LCJpc3MiOiJodHRwczovL3d3dy5uZXRndXJ1LmNvbS8iLCJzdWIiOiIxMjMifQ.-Am1nwkGWz4DHqE1bwW-_-rsjAP0XLb_fqvOBwTcDfI'

```

OR, if you want to access the server directly using port address,

```

curl --location --request GET 'http://localhost:3000/movies' \
--header 'Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOjEyMywibmFtZSI6IkJhc2ljIFRob21hcyIsInJvbGUiOiJiYXNpYyIsImlhdCI6MTY0OTExNzEyOSwiZXhwIjoxNjQ5MTE4OTI5LCJpc3MiOiJodHRwczovL3d3dy5uZXRndXJ1LmNvbS8iLCJzdWIiOiIxMjMifQ.-Am1nwkGWz4DHqE1bwW-_-rsjAP0XLb_fqvOBwTcDfI'

```

Response:

```

{
    "data": [
        {
            "_id": "624b8852ea1e5b0040a43db6",
            "title": "Iron Man 3",
            "release": "Fri May 03 2013 00:00:00 GMT+0000 (Coordinated Universal Time)",
            "genre": "Action, Adventure, Sci-Fi",
            "director": "Shane Black"
        }
    ],
    "message": "List of all movies"
}

```

## Authorization service

## Example request

To authorize user call the auth service using for example `curl`. The default port for auth service is `8888`

Request

```
curl --location --request POST 'localhost/auth' \
--header 'Content-Type: application/json' \
--data-raw '{
    "username": "basic-thomas",
    "password": "sR-_pcoow-27-6PAwCD8"
}'
```

Response

```
{
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOjEyMywibmFtZSI6IkJhc2ljIFRob21hcyIsInJvbGUiOiJiYXNpYyIsImlhdCI6MTYwNjIyMTgzOCwiZXhwIjoxNjA2MjIzNjM4LCJpc3MiOiJodHRwczovL3d3dy5uZXRndXJ1LmNvbS8iLCJzdWIiOiIxMjMifQ.KjZ3zZM1lZa1SB8U-W65oQApSiC70ePdkQ7LbAhpUQg"
}
```

### Postman collection

Inside postman collection you can find all the example requests. I have uploaded the collection json file. Here is the link https://www.getpostman.com/collections/6e8d901ab64216ad9995 as well.

## Tests

**Run tests locally**

With make:

```

make test

```

With docker:

```

cd movie-service &&  JWT_SECRET=<YOUR_SECRET> OMDB_API_KEY=<YOUR_OMDB_API_KEY> docker-compose run --rm app npm test

```

or with npm

```

cd movie-service && npm test

```

Code coverage is 92%.

### CI/CD

Using github actions a CI/CD pipeline has been created. After each pull request the `Test` pipeline is executed.

### API docs (swagger)

API docs is generated using open api specification and swagger. The swagger documentation can be accessed through following url.

```

http://localhost/api-docs

```

OR,

```

http://localhost:3000/api-docs

```

[recruitment-task]: https://github.com/netguru/nodejs-recruitment-task
